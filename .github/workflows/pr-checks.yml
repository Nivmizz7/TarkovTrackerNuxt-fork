name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  pr-meta:
    name: PR Meta
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0

      - name: Auto-label PR
        if: github.event.action != 'labeled' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/labeler@8558fd74291d67161a8a78ce36a881fa63b766a9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate and apply size label
        if: github.event.action != 'labeled' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 100,
            });

            const additions = files.reduce((sum, file) => sum + file.additions, 0);
            const deletions = files.reduce((sum, file) => sum + file.deletions, 0);
            const total = additions + deletions;

            let label = 'size/S';
            if (total > 1000) label = 'size/XXL';
            else if (total > 500) label = 'size/XL';
            else if (total > 250) label = 'size/L';
            else if (total > 100) label = 'size/M';

            const { data: existingLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const sizeLabels = existingLabels
              .map(l => l.name)
              .filter(name => name.startsWith('size/'));

            if (sizeLabels.length === 1 && sizeLabels[0] === label) {
              console.log(`Size label ${label} already correct, skipping`);
              return;
            }

            for (const name of sizeLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name,
                });
              } catch (error) {
                if (error.status !== 404) throw error;
              }
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label],
            });

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version-file: .nvmrc
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate commit messages
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  lighthouse:
    name: Lighthouse
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.head.repo.full_name == github.repository &&
      (contains(github.event.pull_request.labels.*.name, 'performance') ||
       contains(github.event.pull_request.labels.*.name, 'ui'))
    env:
      API_ALLOWED_HOSTS: localhost,127.0.0.1
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version-file: .nvmrc
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          NUXT_PUBLIC_APP_URL: http://localhost:3000
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Start preview server
        run: |
          npx serve dist -s -l 3000 &
          echo $! > /tmp/server.pid
          npx wait-on http://localhost:3000 --timeout 60000 --httpTimeout 20000

      - name: Lighthouse CI
        uses: treosh/lighthouse-ci-action@fcd65974f7c4c2bf0ee9d09b84d2489183c29726
        with:
          configPath: lighthouserc.json
          urls: |
            http://localhost:3000
            http://localhost:3000/tasks
            http://localhost:3000/hideout
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Stop preview server
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            kill "$(cat /tmp/server.pid)" 2>/dev/null || true
            rm -f /tmp/server.pid
          fi

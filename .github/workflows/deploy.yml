name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  PRODUCTION_URL: 'https://tarkovtracker.org'
  API_URL: 'https://api.tarkovtracker.org'

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    permissions:
      contents: read
      deployments: write
      actions: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version-file: .nvmrc
          cache: 'npm'

      - name: Download build artifact from CI
        id: download-artifact
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: build-${{ github.event.workflow_run.head_sha }}
          path: dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Verify artifact downloaded
        if: github.event_name == 'workflow_run'
        env:
          ARTIFACT_NAME: build-${{ github.event.workflow_run.head_sha }}
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "::error::Build artifact not found. The CI workflow may not have uploaded the artifact '$ARTIFACT_NAME'."
            echo "Check that the CI workflow completed successfully and uploaded artifacts."
            exit 1
          fi
          echo "Artifact verified: $(find dist -type f | wc -l) files downloaded"

      - name: Build (manual trigger only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          npm ci
          npm run build
        env:
          NODE_ENV: production
          NUXT_PUBLIC_APP_URL: https://tarkovtracker.org
          NUXT_PUBLIC_APP_VERSION: ${{ github.sha }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@f0a1cd58cd66095dee69bfa18fa5efd1dde93bca
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: tarkovtracker
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy api-gateway
        if: hashFiles('workers/api-gateway/package.json') != ''
        working-directory: workers/api-gateway
        run: |
          npm ci
          npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy team-gateway
        if: hashFiles('workers/team-gateway/package.json') != ''
        working-directory: workers/team-gateway
        run: |
          npm ci
          npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  verify:
    name: Verify
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Smoke test
        run: |
          curl --fail --show-error --retry 5 --retry-delay 5 --retry-all-errors --max-time 30 "$PRODUCTION_URL"
          curl --fail --show-error --retry 5 --retry-delay 5 --retry-all-errors --max-time 15 "$API_URL/health"
          echo "Deployment successful"

      - name: Notify Discord
        if: always() && vars.DISCORD_WEBHOOK_ENABLED == 'true'
        uses: sarisia/actions-status-discord@eb045afee445dc055c18d3d90bd0f244fd062708
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "Deployment ${{ job.status }}"
          description: "Deployed to production"
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
